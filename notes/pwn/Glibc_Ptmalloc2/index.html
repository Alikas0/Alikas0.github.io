



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://blog.lantern.cool/notes/pwn/Glibc_Ptmalloc2/">
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="https://raw.githubusercontent.com/Alikas0/files/master/videos/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>glibc内存管理ptmalloc源代码分析 - Latern’station</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../css/gitalk.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="lime">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#index" tabindex="0" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://blog.lantern.cool" title="Latern’station" aria-label="Latern’station" class="md-header-nav__button md-logo">
          
            <i class="md-icon">border_color</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Latern’station
            </span>
            <span class="md-header-nav__topic">
              
                glibc内存管理ptmalloc源代码分析
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Alikas0/blog_code/tree/master/blog_code/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    blog_code
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://blog.lantern.cool" title="Latern’station" class="md-nav__button md-logo">
      
        <i class="md-icon">border_color</i>
      
    </a>
    Latern’station
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Alikas0/blog_code/tree/master/blog_code/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    blog_code
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Homepage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Homepage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="主页" class="md-nav__link">
      主页
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../links/" title="友情链接" class="md-nav__link">
      友情链接
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      CTF Write-Up
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        CTF Write-Up
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2018/2018rctf/" title="2018 RCTF" class="md-nav__link">
      2018 RCTF
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019suctf/" title="2019 SUCTF" class="md-nav__link">
      2019 SUCTF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019aurora/" title="2019 Aurora内部赛" class="md-nav__link">
      2019 Aurora内部赛
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019rctf/" title="2019 RCTF国际赛" class="md-nav__link">
      2019 RCTF国际赛
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019starctf/" title="2019 *CTF" class="md-nav__link">
      2019 *CTF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019qwb/" title="2019 强网杯" class="md-nav__link">
      2019 强网杯
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2019/2019redhat/" title="2019 红帽杯" class="md-nav__link">
      2019 红帽杯
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      2020
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        2020
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/2020/2020gaoxiaozhanyi/" title="2020 高校战疫" class="md-nav__link">
      2020 高校战疫
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Exams
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Exams
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-1" type="checkbox" id="nav-2-4-1">
    
    <label class="md-nav__link" for="nav-2-4-1">
      BUUCTF
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-1">
        BUUCTF
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/buuctf/introduction/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/buuctf/misc/" title="MISC" class="md-nav__link">
      MISC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/buuctf/reverse/" title="Reverse" class="md-nav__link">
      Reverse
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-2" type="checkbox" id="nav-2-4-2">
    
    <label class="md-nav__link" for="nav-2-4-2">
      旧版Bugku
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-2">
        旧版Bugku
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/old_bugku/introduction/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/old_bugku/reverse/" title="Reverse" class="md-nav__link">
      Reverse
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-3" type="checkbox" id="nav-2-4-3">
    
    <label class="md-nav__link" for="nav-2-4-3">
      实验吧
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-3">
        实验吧
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/shiyanba/introduction/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/exams/shiyanba/reverse/" title="Reverse" class="md-nav__link">
      Reverse
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_write_up/sao/reverse_box/" title="SAO" class="md-nav__link">
      SAO
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      CTF Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        CTF Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_tools/z3/" title="Z3" class="md-nav__link">
      Z3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_tools/xortool/" title="Xortool" class="md-nav__link">
      Xortool
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ctf_tools/ida_python/" title="IDA python" class="md-nav__link">
      IDA python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      SZU OJ Solution
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        SZU OJ Solution
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      数据结构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        数据结构
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/introdution/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-2" type="checkbox" id="nav-4-1-2">
    
    <label class="md-nav__link" for="nav-4-1-2">
      顺序表
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-2">
        顺序表
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1003/1017/" title="DS顺序表--类实现" class="md-nav__link">
      DS顺序表--类实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1003/1018/" title="DS顺序表--连续操作" class="md-nav__link">
      DS顺序表--连续操作
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1003/1019/" title="DS顺序表--合并操作" class="md-nav__link">
      DS顺序表--合并操作
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1003/1020/" title="DS顺序表之循环移位" class="md-nav__link">
      DS顺序表之循环移位
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-3" type="checkbox" id="nav-4-1-3">
    
    <label class="md-nav__link" for="nav-4-1-3">
      单链表
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-3">
        单链表
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1017/1021/" title="DS单链表--类实现" class="md-nav__link">
      DS单链表--类实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1017/1022/" title="DS单链表--结点交换" class="md-nav__link">
      DS单链表--结点交换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1017/1023/" title="DS单链表--合并" class="md-nav__link">
      DS单链表--合并
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1017/1029/" title="DS循环链表—约瑟夫环(Ver. I - A)" class="md-nav__link">
      DS循环链表—约瑟夫环(Ver. I - A)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-4" type="checkbox" id="nav-4-1-4">
    
    <label class="md-nav__link" for="nav-4-1-4">
      链表和栈
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-4">
        链表和栈
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1031/" title="DS堆栈--逆序输出（STL栈使用）" class="md-nav__link">
      DS堆栈--逆序输出（STL栈使用）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1033/" title="DS堆栈--行编辑" class="md-nav__link">
      DS堆栈--行编辑
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1036/" title="DS堆栈--字符替换" class="md-nav__link">
      DS堆栈--字符替换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1024/" title="DS线性表—多项式相加" class="md-nav__link">
      DS线性表—多项式相加
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1025/" title="DS链表—学生宿舍管理" class="md-nav__link">
      DS链表—学生宿舍管理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1029/1109/" title="DS双向链表—祖玛" class="md-nav__link">
      DS双向链表—祖玛
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-5" type="checkbox" id="nav-4-1-5">
    
    <label class="md-nav__link" for="nav-4-1-5">
      栈
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-5">
        栈
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1049/1034/" title="DS堆栈--括号匹配" class="md-nav__link">
      DS堆栈--括号匹配
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1049/1040/" title="DS栈—排队游戏" class="md-nav__link">
      DS栈—排队游戏
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1049/1041/" title="DS栈--Web导航" class="md-nav__link">
      DS栈--Web导航
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1049/1035/" title="DS堆栈--表达式计算" class="md-nav__link">
      DS堆栈--表达式计算
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1049/1032/" title="DS堆栈--迷宫求解" class="md-nav__link">
      DS堆栈--迷宫求解
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-6" type="checkbox" id="nav-4-1-6">
    
    <label class="md-nav__link" for="nav-4-1-6">
      队列
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-6">
        队列
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1062/1037/" title="DS队列之银行排队" class="md-nav__link">
      DS队列之银行排队
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1062/1112/" title="DS队列----银行简单模拟" class="md-nav__link">
      DS队列----银行简单模拟
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1062/1038/" title="DS队列+堆栈--数制转换" class="md-nav__link">
      DS队列+堆栈--数制转换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1062/1039/" title="DS队列--组队列" class="md-nav__link">
      DS队列--组队列
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1062/1113/" title="DS队列----银行单队列多窗口模拟" class="md-nav__link">
      DS队列----银行单队列多窗口模拟
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-7" type="checkbox" id="nav-4-1-7">
    
    <label class="md-nav__link" for="nav-4-1-7">
      串应用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-7">
        串应用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1070/1043/" title="DS串应用--KMP算法" class="md-nav__link">
      DS串应用--KMP算法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1070/1044/" title="DS串应用--串替换" class="md-nav__link">
      DS串应用--串替换
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1070/1046/" title="DS串应用—最长重复子串" class="md-nav__link">
      DS串应用—最长重复子串
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1070/1045/" title="串应用- 计算一个串的最长的真前后缀" class="md-nav__link">
      串应用- 计算一个串的最长的真前后缀
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1070/1047/" title="子串循环问题 (Ver. I)" class="md-nav__link">
      子串循环问题 (Ver. I)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-8" type="checkbox" id="nav-4-1-8">
    
    <label class="md-nav__link" for="nav-4-1-8">
      二叉树及其应用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-8">
        二叉树及其应用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1050/" title="DS二叉树—二叉树构建与遍历（不含框架）" class="md-nav__link">
      DS二叉树—二叉树构建与遍历（不含框架）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1054/" title="DS二叉树——二叉树之数组存储" class="md-nav__link">
      DS二叉树——二叉树之数组存储
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1051/" title="DS二叉树--叶子数量" class="md-nav__link">
      DS二叉树--叶子数量
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1062/" title="DS树--二叉树高度" class="md-nav__link">
      DS树--二叉树高度
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1053/" title="DS二叉树——二叉树之父子结点" class="md-nav__link">
      DS二叉树——二叉树之父子结点
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1071/1055/" title="DS二叉树--层次遍历" class="md-nav__link">
      DS二叉树--层次遍历
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-9" type="checkbox" id="nav-4-1-9">
    
    <label class="md-nav__link" for="nav-4-1-9">
      Huffman树及其应用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-9">
        Huffman树及其应用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1092/1060/" title="DS二叉树——Huffman编码与解码（不含代码框架）" class="md-nav__link">
      DS二叉树——Huffman编码与解码（不含代码框架）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1092/1063/" title="DS树--二叉树之最大路径" class="md-nav__link">
      DS树--二叉树之最大路径
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1092/1061/" title="DS树--带权路径和" class="md-nav__link">
      DS树--带权路径和
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/data_structure/1092/1067/" title="DS二叉树—二叉树镜面反转" class="md-nav__link">
      DS二叉树—二叉树镜面反转
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      C++
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        C++
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2-1" type="checkbox" id="nav-4-2-1">
    
    <label class="md-nav__link" for="nav-4-2-1">
      指针
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-2-1">
        指针
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1035/" title="三数论大小（指针）" class="md-nav__link">
      三数论大小（指针）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1043/" title="成绩查询（指针运算）" class="md-nav__link">
      成绩查询（指针运算）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1038/" title="三串合一（指针与字符数组）" class="md-nav__link">
      三串合一（指针与字符数组）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1036/" title="货币兑换（指针与常量）" class="md-nav__link">
      货币兑换（指针与常量）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1046/" title="密钥加密法（指针应用）" class="md-nav__link">
      密钥加密法（指针应用）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1037/" title="动态数组（指针与数组）" class="md-nav__link">
      动态数组（指针与数组）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1044/" title="动态矩阵（指针与堆内存分配）" class="md-nav__link">
      动态矩阵（指针与堆内存分配）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1039/" title="矩阵左转（指针与数组）" class="md-nav__link">
      矩阵左转（指针与数组）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../szu_oj/cplusplus/1256/1045/" title="函数调用（函数指针）" class="md-nav__link">
      函数调用（函数指针）
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      MISC
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        MISC
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/ubuntu64_32/" title="Ubuntu18.04 64位=>32位程序问题" class="md-nav__link">
      Ubuntu18.04 64位=>32位程序问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/python_http_server/" title="Python SimpleHTTPServer" class="md-nav__link">
      Python SimpleHTTPServer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/python_script/" title="python脚本" class="md-nav__link">
      python脚本
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      提问的智慧
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        提问的智慧
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/introduction/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/before_you_ask/" title="在提问之前" class="md-nav__link">
      在提问之前
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/when_you_ask/" title="当你在提问时" class="md-nav__link">
      当你在提问时
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/how_to_interpret_answers/" title="如何解读答案" class="md-nav__link">
      如何解读答案
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/on_not_reacting_like_loser/" title="如何避免扮演失败者" class="md-nav__link">
      如何避免扮演失败者
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/questions_not_to_ask/" title="不该问的问题" class="md-nav__link">
      不该问的问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/good_and_bad_questions/" title="好问题与蠢问题" class="md-nav__link">
      好问题与蠢问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/if_you_cant_get_an_answer/" title="如果得不到回答" class="md-nav__link">
      如果得不到回答
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/how_to_answer_questions_in_a_helpful_way/" title="如何更好地回答问题" class="md-nav__link">
      如何更好地回答问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/how_to_ask_questions_the_smart_way/how_to_ask_questions_the_smart_way/" title="完整版" class="md-nav__link">
      完整版
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Install WSL
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Install WSL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/wsl/install/" title="安装" class="md-nav__link">
      安装
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/wsl/mklink/" title="mklink软链接到非系统盘" class="md-nav__link">
      mklink软链接到非系统盘
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/wsl/optimization/" title="子系统优化" class="md-nav__link">
      子系统优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/wsl/questions/" title="杂七杂八问题" class="md-nav__link">
      杂七杂八问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/wsl/reference/" title="参考资料" class="md-nav__link">
      参考资料
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../dynamic_static_linking/" title="静态/动态 链接" class="md-nav__link">
      静态/动态 链接
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2" checked>
    
    <label class="md-nav__link" for="nav-6-2">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../function/" title="函数" class="md-nav__link">
      函数
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        glibc内存管理ptmalloc源代码分析
      </label>
    
    <a href="./" title="glibc内存管理ptmalloc源代码分析" class="md-nav__link md-nav__link--active">
      glibc内存管理ptmalloc源代码分析
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    Index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    基础知识
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#x86-linux" class="md-nav__link">
    x86 平台 Linux 进程内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    32 位模式下进程经典内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32_1" class="md-nav__link">
    32 位模式下进程默认内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    64 位模式下进程内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    操作系统内存分配的相关函数
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#heap" class="md-nav__link">
    Heap操作相关的函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap" class="md-nav__link">
    Mmap映射区域操作相关函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    内存管理的一般性描述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    内存管理的方法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1c" class="md-nav__link">
    1.C风格的内存管理程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.池式内存管理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 引用计数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4．垃圾收集
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    内存管理器的设置目标
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1． 最大化兼容性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    2． 最大化可移植性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    3． 浪费最小的空间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    4． 最快的速度
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5． 最大化可调性（以适应于不同的情况）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-locality" class="md-nav__link">
    6．  最大化局部性（Locality）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7． 最大化调试功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8． 最大化适应性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    常见C内存管理程序
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#doug-lea-malloc" class="md-nav__link">
    Doug Lea Malloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bsd-malloc" class="md-nav__link">
    BSD Malloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hoard" class="md-nav__link">
    Hoard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcmalloc" class="md-nav__link">
    TCMalloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c_1" class="md-nav__link">
    各种 C 内存管理程序实现的对比
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ptmalloc" class="md-nav__link">
    Ptmalloc 内存管理概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#index_1" class="md-nav__link">
    Index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    内存管理的设计假设
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    内存管理数据结构概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mainarena-nonmain_arena" class="md-nav__link">
    Mainarena 与 nonmain_arena
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chunk" class="md-nav__link">
    chunk的格式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../big_little_ending/" title="大端序和小端序" class="md-nav__link">
      大端序和小端序
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-4" type="checkbox" id="nav-6-4">
    
    <label class="md-nav__link" for="nav-6-4">
      C++
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-4">
        C++
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cpp/cpp/" title="笔记" class="md-nav__link">
      笔记
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cpp/keywords/" title="关键字(保留字)" class="md-nav__link">
      关键字(保留字)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../base58/" title="Base58" class="md-nav__link">
      Base58
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-6" type="checkbox" id="nav-6-6">
    
    <label class="md-nav__link" for="nav-6-6">
      操作系统
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-6">
        操作系统
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../OS/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    Index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    基础知识
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#x86-linux" class="md-nav__link">
    x86 平台 Linux 进程内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    32 位模式下进程经典内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32_1" class="md-nav__link">
    32 位模式下进程默认内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    64 位模式下进程内存布局
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    操作系统内存分配的相关函数
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#heap" class="md-nav__link">
    Heap操作相关的函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap" class="md-nav__link">
    Mmap映射区域操作相关函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    内存管理的一般性描述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    内存管理的方法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1c" class="md-nav__link">
    1.C风格的内存管理程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.池式内存管理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3. 引用计数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4．垃圾收集
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    内存管理器的设置目标
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1． 最大化兼容性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    2． 最大化可移植性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    3． 浪费最小的空间
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    4． 最快的速度
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5． 最大化可调性（以适应于不同的情况）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-locality" class="md-nav__link">
    6．  最大化局部性（Locality）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7． 最大化调试功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8． 最大化适应性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    常见C内存管理程序
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#doug-lea-malloc" class="md-nav__link">
    Doug Lea Malloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bsd-malloc" class="md-nav__link">
    BSD Malloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hoard" class="md-nav__link">
    Hoard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcmalloc" class="md-nav__link">
    TCMalloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c_1" class="md-nav__link">
    各种 C 内存管理程序实现的对比
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ptmalloc" class="md-nav__link">
    Ptmalloc 内存管理概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#index_1" class="md-nav__link">
    Index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    内存管理的设计假设
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    内存管理数据结构概述
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mainarena-nonmain_arena" class="md-nav__link">
    Mainarena 与 nonmain_arena
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chunk" class="md-nav__link">
    chunk的格式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Alikas0/blog_code/tree/master/blog_code/edit/master/docs/notes/pwn/Glibc_Ptmalloc2.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>glibc内存管理ptmalloc源代码分析</h1>
                
                <h2 id="index">Index</h2>
<p>原文：<a href="https://paper.seebug.org/papers/Archive/refs/heap/glibc%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86ptmalloc%e6%ba%90%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90.pdf">glibc内存管理ptmalloc源代码分析</a></p>
<p>跟着学习部分知识并补充不懂的知识</p>
<h2 id="_1">基础知识</h2>
<h3 id="x86-linux">x86 平台 Linux 进程内存布局</h3>
<p>Linux 系统在加载elf格式的程序文件时, 会调用loader把可执行文件中的各个段依次载入到某一地址开始的空间中（载入地址取决于link editor(ld) 和机器地址的位数, 在32位机器上是 0x8048000, 即 128M 处）
如图所示，以32位机器为例，首先被载入的是.text段，然后是.data段，最后是.bss段。</p>
<p>可以看作是程序的开始空间，程序所能访问的最后地址是0xbfffffff, 也就是到3G地址， 3G以上的1G空间是
内核使用的，应用程序不能直接访问。</p>
<p>应用程序的堆栈从最高地址处开始向下生长, .bss段与堆栈之间的空间是空闲的，空闲的空间被分成两部分： 一部分为heap，另一部分为mmap映射区域。</p>
<p>mmap映射区域一般从TASK_SIZE/3 的地方开始，但是在不同的Linux内核和机器上， mmap区域的开始位置一般是不同的。</p>
<p>Heap和mmap区域都可以供用户自由使用，但在开始未映射到内存空间内，是不可访问的。</p>
<p>在向内核请求分配该空间之前，对这个空间的访问会导致segmentation fault。</p>
<p>用户程序可以直接使用系统调用来管理 heap 和 mmap 映射区域， 但更多时候程序使用的都是C语言提供的 malloc() 和 free()
 函数来动态的分配和释放内存。</p>
<p>Stack区域是唯一不需要映射，用户却可以访问的内存区域， 这也是利用堆栈溢出进行攻击的基础</p>
<h3 id="32">32 位模式下进程经典内存布局</h3>
<p><img alt="32位模式下进程内存经典布局" src="https://raw.githubusercontent.com/Alikas0/files/master/img/20191116165530.png" /></p>
<p>这种布局是 Linux 内核 2.6.7 以前的默认进程内存布局形式, mmap 区域与栈区域相对增长, 这意味着堆只有1GB的<a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/virtual-address-spaces">虚拟地址</a>可以使用, 继续增长就会进入mmap映射区域, 这显然不是我们想要的。</p>
<p>这是由于32模式地址空间造成的， 所以内核引入了另一种虚拟地址空间布局的形式， 将在后面介绍。 但对于64位系统， 提供了巨大的虚拟地址空间， 这种布局就相当好。 </p>
<h3 id="32_1">32 位模式下进程默认内存布局</h3>
<p><img alt="" src="https://raw.githubusercontent.com/Alikas0/files/master/img/20191117154156.png" /></p>
<p>这种布局是 Linux 内核 2.6.7 以后的默认进程内存布局形式，栈至顶向下扩展，并且栈是有界的。 堆至底向上扩展， mmap 映射区域至顶向下扩展， mmap 映射区域和堆相对扩展， 直到耗尽虚拟地址空间中的剩余区域， 这种结构便于 C <a href="https://zh.wikipedia.org/wiki/%E8%BF%90%E8%A1%8C%E6%97%B6%E5%BA%93">运行时库</a> 使用 mmap 映射区域和堆进行内存分配。</p>
<h3 id="64">64 位模式下进程内存布局</h3>
<p>对 AMD64 系统， 内存布局采用经典布局， text 的起始地址为 0x0000000000400000， 堆紧接着BSS段向上增长， mmap 映射区域开始位置一般设为 TASK_SIZE/3</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#define TASK_SIZE_MAX ((1UL &lt;&lt; 47) - PAGE_SIZE)</span>
<span class="cp">#define TASK_SIZE (test_thread_flag(TIF_IA32) ? \</span>
<span class="cp"> IA32_PAGE_OFFSET : TASK_SIZE_MAX)</span>
<span class="cp">#define STACK_TOP TASK_SIZE</span>
<span class="cp">#define TASK_UNMAPPED_BASE (PAGE_ALIGN(TASK_SIZE / 3))</span>
</code></pre></div>
</td></tr></table>

<p>可知，mmap开始区域为 0x00002AAAAAAAA000，栈顶地址为 0x00007FFFFFFFF000</p>
<p><img alt="X86_64 下 Linux 进程的默认内存布局形式" src="https://raw.githubusercontent.com/Alikas0/files/master/img/20191117162202.png" /></p>
<p>上图X86_64 下 Linux 进程的默认内存布局形式的示意图， 当前内核默认配置下， 进程的栈和mmap 映射区域 并不是从一个固定地址开始的， 并且每次启动时的值都不一样， 这是程序在启动时随机改变这些值的设置，使得使用缓冲区溢出进行攻击更加困难。</p>
<p>当然也可以让进程的栈和 mmap 映射区域从一个固定位置开始，只需要设置全局变量 randomize<em>va</em>space 值为0 ， 这个变量默认值为 1 。 用户可以通过设置<code>proc/sys/kernel/randomize_va_space</code>来停用该特性，也可以用如下命令：</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ sudo sysctl -w kernel.randomize_va_space=0
</code></pre></div>
</td></tr></table>
或者是
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ sudo echo 0 &gt;/proc/sys/kernel/randomize_va_space 
</code></pre></div>
</td></tr></table></p>
<details class="note"><summary>Linux <a href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9D%80%E7%A9%BA%E9%96%93%E9%85%8D%E7%BD%AE%E9%9A%A8%E6%A9%9F%E8%BC%89%E5%85%A5">内存地址随机化机制</a></summary><p>randomize<em>va</em>space的值有三种，分别是[0,1,2]</p>
<p>0 - 表示关闭进程地址空间随机化</p>
<p>1 - 表示将mmap的基址，stack和vdso页面随机化</p>
<p>2 - 表示在1的基础上增加栈（heap）的随机化</p>
</details>
<h3 id="_2">操作系统内存分配的相关函数</h3>
<ul>
<li>
<p>对heap操作: </p>
<ul>
<li>操作系统:<code>brk()</code></li>
<li><a href="https://blog.csdn.net/wqvbjhc/article/details/6612099">C运行时库</a>:<code>sbrk()</code> </li>
</ul>
</li>
<li>
<p>对mmap映射区域的操作</p>
<ul>
<li>操作系统<code>mmap()</code> 和 <code>munmap()</code></li>
</ul>
</li>
</ul>
<p>sbrk()、 brk() 、 mmap() 都可以为进程添加额外的虚拟内存</p>
<p>Glibc同样是使用这些函数对操作系统申请虚拟内存</p>
<p><strong>重要概念</strong>： 内存的延迟分配，只有在真正访问一个地址的啥时候才建立这个地址的物理映射, 这是Linux内存管理的基本思想之一。</p>
<p>Linux 内核在用户申请内存的时候，只是给它分配了一个线性区（也就是虚拟内存），并没有分配实际物理内存；只有当用户使用这块内存的时候，内核才会分配具体的物理页面给用户，这时候才占用宝贵的物理内存。内核释放物理页面是通过释放线性区，找到其所对应的物理页面，将其全部释放的过程。</p>
<h4 id="heap">Heap操作相关的函数</h4>
<p>Heap 操作函数主要有两个， brk()为系统调用， sbrk()为C库函数。 系统调用通常会提供一种最小功能， 而库函数通常提供比较复杂的功能。 Glibc的malloc族(realloc, calloc 等)就调用sbrk()函数将数据段下届移动，sbrk() 函数在内核的管理下将<a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/virtual-address-spaces">虚拟地址空间</a>映射到内存，拱 malloc() 函数使用</p>
<p>内核数据结构mm<em>struct中的成员变量start</em>code和end<em>cod是进程代码段的起始和终止地址，start</em>data 和 end<em>data 是进程数据段的起始和终止地址，start</em>stack 是进程堆栈段起始地址，start_brk 是进程动态内存分配起始地址（堆的起始地址），还有一个 brk（堆的当前最后地址），就是动态内存分配当前的终止地址。</p>
<p>C 语言的动态内存分配基本函数是malloc()，在 Linux 上的实现是通过内核的 brk 系统调用。brk()是一个非常简单的系统调用，只是简单地改变 mm_struct 结构的成员变量 brk 的值。</p>
<p>函数定义如下:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>NAME
       brk, sbrk - change data segment size
SYNOPSIS
       #include &lt;unistd.h&gt;
       int brk(void *addr);
       void *sbrk(intptr_t increment);
</code></pre></div>
</td></tr></table>

<details class="note"><summary>brk() 和 sbrk()</summary><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">DESCRIPTION</span>
   <span class="n">brk</span><span class="p">()</span>  <span class="k">and</span> <span class="n">sbrk</span><span class="p">()</span> <span class="n">change</span> <span class="n">the</span> <span class="k">location</span> <span class="k">of</span> <span class="n">the</span> <span class="n">program</span> <span class="n">break</span><span class="p">,</span> <span class="n">which</span> <span class="n">defines</span> <span class="n">the</span> <span class="k">end</span> <span class="k">of</span>
   <span class="n">the</span> <span class="n">process</span><span class="s1">&#39;s data segment (i.e., the program break is the first location after  the</span>
<span class="s1">   end of the uninitialized data segment).  Increasing the program break has the effect</span>
<span class="s1">   of allocating memory to the process; decreasing the break deallocates memory.</span>

<span class="s1">   brk() sets the end of the data segment to the value specified  by  addr,  when  that</span>
<span class="s1">   value  is  reasonable, the system has enough memory, and the process does not exceed</span>
<span class="s1">   its maximum data size (see setrlimit(2)).</span>

<span class="s1">   sbrk() increments the program&#39;</span><span class="n">s</span> <span class="k">data</span> <span class="k">space</span> <span class="k">by</span> <span class="k">increment</span> <span class="n">bytes</span><span class="p">.</span>  <span class="n">Calling</span> <span class="n">sbrk</span><span class="p">()</span>  <span class="k">with</span>
   <span class="n">an</span> <span class="k">increment</span> <span class="k">of</span> <span class="mi">0</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="k">to</span> <span class="n">find</span> <span class="n">the</span> <span class="k">current</span> <span class="k">location</span> <span class="k">of</span> <span class="n">the</span> <span class="n">program</span> <span class="n">break</span><span class="p">.</span>

<span class="k">RETURN</span> <span class="n">VALUE</span>
   <span class="k">On</span>  <span class="n">success</span><span class="p">,</span>  <span class="n">brk</span><span class="p">()</span>  <span class="k">returns</span>  <span class="n">zero</span><span class="p">.</span>   <span class="k">On</span>  <span class="n">error</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">is</span> <span class="n">returned</span><span class="p">,</span> <span class="k">and</span> <span class="n">errno</span> <span class="k">is</span> <span class="k">set</span> <span class="k">to</span>
   <span class="n">ENOMEM</span><span class="p">.</span>

   <span class="k">On</span> <span class="n">success</span><span class="p">,</span> <span class="n">sbrk</span><span class="p">()</span> <span class="k">returns</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">program</span> <span class="n">break</span><span class="p">.</span>  <span class="p">(</span><span class="k">If</span> <span class="n">the</span> <span class="n">break</span> <span class="n">was</span> <span class="n">increased</span><span class="p">,</span>
   <span class="k">then</span> <span class="n">this</span> <span class="n">value</span> <span class="k">is</span> <span class="n">a</span> <span class="n">pointer</span> <span class="k">to</span> <span class="n">the</span> <span class="k">start</span> <span class="k">of</span> <span class="n">the</span> <span class="n">newly</span> <span class="n">allocated</span> <span class="n">memory</span><span class="p">).</span>  <span class="k">On</span> <span class="n">error</span><span class="p">,</span>
   <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="k">is</span> <span class="n">returned</span><span class="p">,</span> <span class="k">and</span> <span class="n">errno</span> <span class="k">is</span> <span class="k">set</span> <span class="k">to</span> <span class="n">ENOMEM</span><span class="p">.</span>
</code></pre></div>
</td></tr></table>

<p>brk() 直接修改有效访问范围的末尾地址来实现分配和回收
sbrk() increment为正值时扩展brk值， 当increment为负值时收缩brk值， 当increment = 0时，sbrk()函数返回当前brk值</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;sbrk&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">brk</span><span class="p">(</span><span class="n">old</span><span class="p">);</span> <span class="c1">// 虽然，sbrk()与brk()均可分配回收兼职，但是我们一般用sbrk()分配内存，而用brk()回收内存; brk(old) 等价于 sbrk(-0x100)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;brk&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">free</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;old: %p</span><span class="se">\n</span><span class="s">p: %p</span><span class="se">\n</span><span class="s">new: %p</span><span class="se">\n</span><span class="s">free: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;size: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">new</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">old</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>输出：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>old: 0x7fffcea72000
p: 0x7fffcea72000
new: 0x7fffcea72100
free: 0x7fffcea72000
size: 100
</code></pre></div>
</td></tr></table>

<p>由于缓冲区在堆，而一旦使printf、getchar等需要使用缓冲区时，就会预先申请0x21000大小的堆块以供程序使用(<em>wsl:ubuntu18.04;gcc (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0</em>)</p>
<p>若在<code>sbrk(0x100)</code>前<code>sbrk(0)</code>后<code>getchar</code>：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;sbrk&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;old: %p</span><span class="se">\n</span><span class="s">p: %p</span><span class="se">\n</span><span class="s">new: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;size: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">new</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">old</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>输出:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>old: 0x7fffc4d13000
p: 0x7fffc4d34000
new: 0x7fffc4d34100
size: 21100
</code></pre></div>
</td></tr></table>

<p>这时如果使用<code>brk(old)</code>会导致将stdio申请的堆块缩掉导致printf访问时报错</p>
</details>
<h4 id="mmap">Mmap映射区域操作相关函数</h4>
<p>mmap() 函数将一个文件或者其他对象映射进内存。 文件被映射到多个页（<a href="https://www.ibm.com/developerworks/cn/linux/l-memmod/index.html">内存页</a>）上，如果文件大小不是所有页的大小之和，最后一个页不被使用的空间将会被清零。 </p>
<details class="note"><summary><a href="https://www.zhihu.com/question/50796850">怎么理解操作系统中内存管理分页和分段</a></summary><ol>
<li>
<p>这两个技术都是为了利用和管理好计算机的资源————内存</p>
<p>在分段这个技术还没有出现之前，程序运行是需要从内存中分配出足够多的连续的内存，然后把整个程序装载进去, 如果找不到连续的符合大小的空间就无法将程序装载进去，程序也就无法运行</p>
</li>
<li>
<p>问题</p>
<ul>
<li>
<p>地址空间不隔离：操作程序A的地址时可能会误操作到程序B</p>
</li>
<li>
<p>程序运行时地址不确定： 程序装载进内存的地址是随机的</p>
</li>
<li>
<p>内存利用率低下：若程序A大小10M, 程序B大小70M, 程序C大小30M, 计算机内存共100M则你无法同时运行这三个程序。若A地址0x0<sub>0x9,B地址0x10</sub>0x79,此时若加载C，只能换出程序B到磁盘上，保留程序A。此时有<strong>60M内存无法利用</strong>。</p>
</li>
</ul>
</li>
</ol>
<p>3.计算机科学领域的任何问题都可以通过增加一个间接的<strong>中间层</strong>来解决(例如很多优秀的中间层：Nginx、Redis等等)</p>
<p>4.分段</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="o">-</span> <span class="err">把虚拟地址空间映射到了物理地址空间，并且你写的程序操作的是虚拟地址</span><span class="p">,</span> <span class="err">此时不需要连续的物理内存来存放</span><span class="n">A</span><span class="p">,</span> <span class="err">且假设程序</span><span class="n">A的虚拟地址空间是0x00000000</span><span class="o">~</span><span class="mi">0</span><span class="n">x00000099</span><span class="p">,</span> <span class="err">映射到的物理地址空间是</span><span class="mi">0</span><span class="n">x00000600</span><span class="o">~</span><span class="mi">0</span><span class="n">x00000699</span><span class="p">,</span><span class="err">此时用程序</span><span class="n">A操作地址0x150</span><span class="err">，英文此时的地址</span><span class="mi">0</span><span class="n">x00000150是虚拟的</span><span class="err">，而虚拟化的操作是在操作系统的掌控中的，所以，操作系统有能力判断，这个虚拟地址</span><span class="mi">0</span><span class="n">x00000150是有问题的</span><span class="err">，然后阻止后续的操作。所以，体现出了隔离性。（另一种体现隔离性的方式就是，操作同一个虚拟地址，实际上可能操作的是不同的物理地址）</span>

<span class="o">-</span> <span class="err">分段机制，映射的是一片连续的物理内存，所以问题</span><span class="mi">3</span><span class="err">得不到解决</span>
</code></pre></div>
</td></tr></table>

<p>5.分页</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="o">-</span> <span class="err">分页这个技术仍然是一种虚拟地址空间到物理地址空间映射的机制。但是，粒度更加的小了。单位不是整个程序，而是某个“页”，一段虚拟地址空间组成的某一页映射到一段物理地址空间组成的某一页</span>

<span class="o">-</span> <span class="err">在基本的分页概念中，我们把程序分成等长的小块。这些小块叫做“页（</span><span class="n">Page</span><span class="err">）”，同样内存也被我们分成了和页面同样大小的”页框（</span><span class="n">Frame</span><span class="err">）“，一个页可以装到一个页框里。在执行程序的时候我们根据一个页表去查找某个页面在内存的某个页框中，由此完成了逻辑到物理的映射</span>
</code></pre></div>
</td></tr></table>

</details>
<p>munmap() 执行相反的操作，删除特定地址区域的对象映射。</p>
<p>函数定义如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>NAME
       mmap, munmap - map or unmap files or devices into memory

SYNOPSIS
       #include &lt;sys/mman.h&gt;

       void *mmap(void *addr, size_t length, int prot, int flags,
                  int fd, off_t offset);
       int munmap(void *addr, size_t length);

       See NOTES for information on feature test macro requirements.
</code></pre></div>
</td></tr></table>

<p>参数：</p>
<ul>
<li>
<p>start：映射区的开始地址</p>
</li>
<li>
<p>length：映射区的长度</p>
</li>
<li>
<p>prot：期望的内存保护标志，不能与文件的打开模式冲突。是以下的某个值，可以通过
or 运算合理地组合在一起。Ptmalloc 中主要使用了如下的几个标志:</p>
<ul>
<li>
<p>PROT_EXEC //页内容可以被执行，ptmalloc 中没有使用</p>
</li>
<li>
<p>PROT_READ //页内容可以被读取，ptmalloc 直接用 mmap 分配内存并立即返回给用户时设置该标志</p>
</li>
<li>
<p>PROT_WRITE //页可以被写入，ptmalloc 直接用 mmap 分配内存并立即返回给用户时设置该标志</p>
</li>
<li>
<p>PROT_NONE //页不可访问，ptmalloc 用 mmap 向系统“批发”一块内存进行管理时设置该标志</p>
</li>
</ul>
</li>
<li>
<p>flags：指定映射对象的类型，映射选项和映射页是否可以共享。它的值可以是一个或者多个以下位的组合体</p>
<ul>
<li>
<p>MAP_FIXED //使用指定的映射起始地址，如果由 start 和 len 参数指定的内存区重叠于现存的映射空间，重叠部分将会被丢弃。如果指定的起始地址不可用，操作将会失败。并且起始地址必须落在页的边界上。Ptmalloc 在回收从系统中“批发”的内存时设置该标志</p>
</li>
<li>
<p>MAP_PRIVATE //建立一个写入时拷贝的私有映射。内存区域的写入不会影响到原文件。这个标志和以上标志是互斥的，只能使用其中一个。Ptmalloc每次调用mmap都设置该标志</p>
</li>
<li>
<p>MAP_NORESERVE //不要为这个映射保留交换空间。当交换空间被保留，对映射区修改的可能会得到保证。当交换空间不被保留，同时内存不足，对映射区的修改会引起段违例信号。Ptmalloc 向系统“批发”内存块时设置该标志</p>
</li>
<li>
<p>MAP_ANONYMOUS //匿名映射，映射区不与任何文件关联。Ptmalloc 每次调用 mmap 都设置该标志</p>
</li>
</ul>
</li>
<li>
<p>fd：有效的文件描述词。如果 MAP_ANONYMOUS 被设定，为了兼容问题，其值应为-1</p>
</li>
<li>
<p>offset：被映射对象内容的起点。</p>
</li>
</ul>
<h2 id="_3">概述</h2>
<h3 id="_4">内存管理的一般性描述</h3>
<p>当不知道程序的每个部分将需要多少内存时， 系统内存空间有限， 而内存需求又是变化的， 这时就需要内存管理程序来负责分配和回收内存。程序的动态性越强， 内存管理就越重要， 内存分配程序的选择也就更重要</p>
<h4 id="_5">内存管理的方法</h4>
<p>可用于内存管理的方法有许多种，它们各有好处与不足，不同的内存管理方法有最适用的情形。</p>
<h5 id="1c">1.C风格的内存管理程序</h5>
<p>C风格的内存管理程序主要实现<strong>malloc()</strong> 和 <strong>free()</strong>. 内存管理程序主要通过调用brk() 或者 mmap() 进程来添加额外的虚拟内存。</p>
<p>Doug Lea Malloc，ptmalloc，BSD malloc，Hoard，TCMalloc 都属于这一类内存管理程序。</p>
<p>基于 malloc()的内存管理器仍然有很多缺点，不管使用的是哪个分配程序。</p>
<ul>
<li>
<p>对于那些需要保持长期存储的程序使用 malloc()来管理内存可能会非常令人失望。</p>
</li>
<li>
<p>如果有大量的不固定的内存引用，经常难以知道它们何时被释放。</p>
</li>
<li>
<p>生存期局限于当前函数的内存非常容易管理，但是对于生存期超出该范围的内存来说，管理内存则困难得多。因为管理内存的问题，很多程序倾向于使用它们自己的内存管理规则。</p>
</li>
</ul>
<h5 id="2">2.池式内存管理</h5>
<p>内存池是一种半内存管理方法。</p>
<p>内存池帮助某些程序进行自动内存管理，这些程序会经历一些特定的阶段，而且每个阶段中都有分配给进程的特定阶段的内存。</p>
<p>例如，很多网络服务器进程都会分配很多针对每个连接的内存——内存的最大生存期限为当前连接的存在期。</p>
<p>Apache 使用了池式内存（pooled memory），将其连接拆分为各个阶段，每个阶段都有自己的内存池。在结束每个阶段时，会一次释放所有内存。</p>
<p>在池式内存管理中，每次内存分配都会指定内存池，从中分配内存。每个内存池都有不同的生存期限。</p>
<p>在 Apache 中，有一个持续时间为服务器存在期的内存池，还有一个持续时间为连接的存在期的内存池，以及一个持续时间为请求的存在期的池，另外还有其他一些内存池。</p>
<p>因此，如果一系列函数不会生成比连接持续时间更长的数据，那么就可以完全从连接池中分配内存，并知道在连接结束时，这些内存会被自动释放。另外，有一些实现允许注册清除函数（cleanup functions），在清除内存池之前，恰好可以调用它，来完成在内存被清理前需要完成的其他所有任务（类似于面向对象中的析构函数）。</p>
<p>使用池式内存分配的优点如下所示：</p>
<ul>
<li>
<p>应用程序可以简单地管理内存。</p>
</li>
<li>
<p>内存分配和回收更快，因为每次都是在一个池中完成的。分配可以在 O(1)时间内完成，释放内存池所需时间也差不多（实际上是 O(n)时间，不过在大部分情况下会除以一个大的因数，使其变成 O(1)）。</p>
</li>
<li>
<p>可以预先分配错误处理池（Error-handling pools），以便程序在常规内存被耗尽时仍可以恢复。</p>
</li>
<li>
<p>有非常易于使用的标准实现。</p>
</li>
</ul>
<p>池式内存的缺点是：</p>
<ul>
<li>
<p>内存池只适用于操作可以分阶段的程序。</p>
</li>
<li>
<p>内存池通常不能与第三方库很好地合作。</p>
</li>
<li>
<p>如果程序的结构发生变化，则不得不修改内存池，这可能会导致内存管理系统的重新设计。</p>
</li>
<li>
<p>您必须记住需要从哪个池进行分配。另外，如果在这里出错，就很难捕获该内存池。</p>
</li>
</ul>
<h5 id="3">3. 引用计数</h5>
<p>在引用计数中，所有共享的数据结构都有一个域来包含当前活动“引用”结构的次数。<br />
当向一个程序传递一个指向某个数据结构指针时，该程序会将引用计数增加 1。
实质上，是在告诉数据结构，它正在被存储在多少个位置上。
然后，当进程完成对它的使用后，该程序就会将引用计数减少 1。
结束这个动作之后，它还会检查计数是否已经减到零。
如果是，那么它将释放内存。</p>
<p>在 Java，Perl 等高级语言中，进行内存管理时使用引用计数非常广泛。
在这些语言中，引用计数由语言自动地处理，所以您根本不必担心它，除非要编写扩展模块。
由于所有内容都必须进行引用计数，所以这会对速度产生一些影响，但它极大地提高了编程的安全性和方便性。</p>
<p>以下是引用计数的<strong>好处</strong>：</p>
<ul>
<li>
<p>实现简单</p>
</li>
<li>
<p>易于使用</p>
</li>
<li>
<p>由于引用是数据结构的一部分， 所以它有一个好的缓存位置</p>
</li>
</ul>
<p><strong>不足</strong>：</p>
<ul>
<li>
<p>要求您永远不要忘记调用引用计数函数</p>
</li>
<li>
<p>无法释放作为循环数据结构的一部分的结构</p>
</li>
<li>
<p>减缓几乎每一个指针的分配</p>
</li>
<li>
<p>尽管所使用的对象采用了引用计数，但是当使用异常处理（比如 try 或 setjmp()/ longjmp()）时，您必须采取其他方法  </p>
</li>
<li>
<p>需要额外的内存来处理引用 </p>
</li>
<li>
<p>引用计数占用了结构中的第一个位置，在大部分机器中最快可以访问到的就是这个位置</p>
</li>
<li>
<p>在多线程环境中更慢也更难以使用</p>
</li>
</ul>
<h5 id="4">4．垃圾收集</h5>
<p>垃圾收集（Garbage collection）是全自动地检测并移除不再使用的数据对象。
垃圾收集 器通常会在当可用内存减少到少于一个具体的阈值时运行。
通常，它们以程序所知的可用的 一组“基本”数据——栈数据、全局变量、寄存器——作为出发点。
然后它们尝试去追踪通过这些数据连接到每一块数据。
收集器找到的都是有用的数据；它没有找到的就是垃圾，可以被销毁并重新使用这些无用的数据。
为了有效地管理内存，很多类型的垃圾收集器都需要知道数据结构内部指针的规划，
所以，为了正确运行垃圾收集器，它们必须是语言本身的一部分。 </p>
<p>垃圾收集的一些<strong>优点</strong>：  </p>
<ul>
<li>
<p>永远不必担心内存的双重释放或者对象的生命周期</p>
</li>
<li>
<p>使用某些收集器，您可以使用与常规分配相同的 API</p>
</li>
</ul>
<p>其<strong>缺点</strong>包括：</p>
<ul>
<li>
<p>使用大部分收集器时，您都无法干涉何时释放内存</p>
</li>
<li>
<p>在多数情况下，垃圾收集比其他形式的内存管理更慢</p>
</li>
<li>
<p>垃圾收集错误引发的缺陷难于调试</p>
</li>
<li>
<p>如果您忘记将不再使用的指针设置为null，那么仍然会有内存泄漏</p>
</li>
</ul>
<h3 id="_6">内存管理器的设置目标</h3>
<p>内存管理器为什么难写？在设计内存管理算法时，要考虑什么因素？管理内存这是内存管理器的功能需求。
正如设计其它软件一样，质量需求一样占有重要的地位。分析内存管理算法之前，我们先看看对内存管理算法的质量需求有哪些： </p>
<h4 id="1">1． 最大化兼容性</h4>
<p>要实现内存管理器时，先要定义出分配器的接口函数。接口函数没有必要标新立异，而是要遵循现有标准（如 POSIX 或者 Win32），让使用者可以平滑的过度到新的内存管理器上。 </p>
<h4 id="2_1">2． 最大化可移植性</h4>
<p>通常情况下，内存管理器要向 OS 申请内存，然后进行二次分配。所以，在适当的时候 要扩展内存或释放多余的内存，这要调用 OS 提供的函数才行。OS 提供的函数则是因平台而异，尽量抽象出平台相关的代码，保证内存管理器的可移植性。 </p>
<h4 id="3_1">3． 浪费最小的空间</h4>
<p>内存管理器要管理内存，必然要使用自己一些数据结构，这些数据结构本身也要占内存空间。在用户眼中，这些内存空间毫无疑问是浪费掉了，如果浪费在内存管理器身的内存太多，显然是不可以接受的。 内存碎片也是浪费空间的罪魁祸首，若内存管理器中有大量的内存碎片，它们是一些不连续的小块内存，它们总量可能很大，但无法使用，这也是不可以接受的。 </p>
<h4 id="4_1">4． 最快的速度</h4>
<p>内存分配/释放是常用的操作。按着 2/8 原则，常用的操作就是性能热点，热点函数的 性能对系统的整体性能尤为重要。  </p>
<h4 id="5">5． 最大化可调性（以适应于不同的情况）</h4>
<p>内存管理算法设计的难点就在于要适应用不同的情况。事实上，如果缺乏应用的上下文， 是无法评估内存管理算法的好坏的。可以说在任何情况下，专用算法都比通用算法在时/空 性能上的表现更优。 为每种情况都写一套内存管理算法，显然是不太合适的。我们不需要追求最优算法，那 样代价太高，能达到次优就行了。设计一套通用内存管理算法，通过一些参数对它进行配置， 可以让它在特定情况也有相当出色的表现，这就是可调性。 </p>
<h4 id="6-locality">6．  最大化局部性（Locality）</h4>
<p>大家都知道，使用 cache 可以提高程度的速度，但很多人未必知道 cache 使程序速度提高的真正原因。拿 CPU 内部的 cache 和 RAM 的访问速度相比，速度可能相差一个数量级。 两者的速度上的差异固然重要，但这并不是提高速度的充分条件，只是必要条件。 另外一个条件是程序访问内存的局部性（Locality）。大多数情况下，程序总访问一块内 存附近的内存，把附近的内存先加入到 cache 中，下次访问 cache 中的数据，速度就会提高。 否则，如果程序一会儿访问这里，一会儿访问另外一块相隔十万八千里的内存，这只会使数 据在内存与 cache 之间来回搬运，不但于提高速度无益，反而会大大降低程序的速度。 因此，内存管理算法要考虑这一因素，减少 cache miss 和 page fault。 </p>
<h4 id="7">7． 最大化调试功能</h4>
<p>作为一个 C/C++程序员，内存错误可以说是我们的噩梦，上一次的内存错误一定还让你忆犹新。内存管理器提供的调试功能，强大易用，特别对于嵌入式环境来说，内存错误检测工具缺乏，内存管理器提供的调试功能就更是不可或缺了。 </p>
<h4 id="8">8． 最大化适应性</h4>
<p>前面说了最大化可调性，以便让内存管理器适用于不同的情况。但是，对于不同情况都要去调设置，无疑太麻烦，是非用户友好的。要尽量让内存管理器适用于很广的情况，只有极少情况下才去调设置。 </p>
<p>设计是一个多目标优化的过程，有些目标之间存在着竞争。如何平衡这些竞争力是设计的难点之一。在不同的情况下，这些目标的重要性又不一样，所以根本不存在一个最好的内 存分配算法。 </p>
<p>一切都需要折衷：性能、易用、易于实现、支持线程的能力等，为了满足项目的要求， 有很多内存管理模式可供使用。每种模式都有大量的实现，各有其优缺点。内存管理的设计 目标中，有些目标是相互冲突的，比如最快的分配、释放速度与内存的利用率，也就是内存 碎片问题。不同的内存管理算法在两者之间取不同的平衡点。     </p>
<p>为了提高分配、释放的速度，多核计算机上，主要做的工作是避免所有核同时在竞争内 存，常用的做法是内存池，简单来说就是批量申请内存，然后切割成各种长度，各种长度都 有一个链表，申请、释放都只要在链表上操作，可以认为是 O(1)的。不可能所有的长度都对 应一个链表。很多内存池是假设，A 释放掉一块内存后，B 会申请类似大小的内存，但是 A 释放的内存跟 B 需要的内存不一定完全相等，可能有一个小的误差，如果严格按大小分配， 会导致复用率很低，这样各个链表上都会有很多释放了，但是没有复用的内存，导致利用率 很低。这个问题也是可以解决的，可以回收这些空闲的内存，这就是传统的内存管理，不停 地对内存块作切割和合并，会导致效率低下。所以通常的做法是只分配有限种类的长度。一 般的内存池只提供几十种选择。</p>
<h3 id="c">常见C内存管理程序</h3>
<h4 id="doug-lea-malloc">Doug Lea Malloc</h4>
<p>Doug Lea Malloc 实际上是完整的一组分配程序，其中包括 Doug Lea 的原始分配程序，GNU libc 分配程序和 ptmalloc。Doug Lea 的分配程序加入了索引， 这使得搜索速度更快，并且可以将多个没有被使用的块组合为一个大的块。它还支 持缓存，以便更快地再次使用最近释放的内存。ptmalloc 是 Doug Lea Malloc 的一个 扩展版本，支持多线程。在本文后面的部分详细分析 ptamlloc2 的源代码实现</p>
<h4 id="bsd-malloc">BSD Malloc</h4>
<p>BSD Malloc 是随 4.2 BSD 发行的实现，包含在 FreeBSD 之中，这个分配 程序可以从预先确实大小的对象构成的池中分配对象。它有一些用于对象大小的 size 类，这些对象的大小为 2 的若干次幂减去某一常数。所以，如果您请求给定大小的一个对象，它就简单地分配一个与之匹配的 size 类。这样就提供了一个快速的 实现，但是可能会浪费内存</p>
<h4 id="hoard">Hoard</h4>
<p>编写 Hoard 的目标是使内存分配在多线程环境中进行得非常快。因此，它的 构造以锁的使用为中心，从而使所有进程不必等待分配内存。它可以显著地加快那 些进行很多分配和回收的多线程进程的速度</p>
<h4 id="tcmalloc">TCMalloc</h4>
<p>Thread-Caching Malloc）是 google 开发的开源工具──“google-perftools” 中的成员。与标准的 Glibc 库的 malloc 相比，TCMalloc 在内存的分配上效率和速度 要高得多。TCMalloc 是一种通用内存管理程序，集成了内存池和垃圾回收的优点， 对于小内存，按 8 的整数次倍分配，对于大内存，按 4K 的整数次倍分配。这样做有两 个好处，一是分配的时候比较快，那种提供几十种选择的内存池，往往要遍历一遍各种 长度，才能选出合适的种类，而 TCMalloc 则可以简单地做几个运算就行了。二是短期 的收益比较大，分配的小内存至多浪费 7 个字节，大内存则 4K。但是长远来说，TCMalloc 分配的种类还是比别的内存池要多很多的，可能会导致复用率很低。 TCMalloc 还有一套 高效的机制回收这些空闲的内存。当一个线程的空闲内存比较多的时候，会交还给进程， 进程可以把它调配给其他线程使用；如果某种长度交还给进程后，其他线程并没有需求， 进程则把这些长度合并成内存页，然后切割成其他长度。如果进程占据的资源比较多呢， 据说不会交回给操作系统。周期性的内存回收，避免可能出现的内存爆炸式增长的问 题。TCMalloc 有比较高的空间利用率，只额外花费 1%的空间。尽量避免加锁（一次 加锁解锁约浪费 100ns），使用更高效的 spinlock，采用更合理的粒度。小块内存和 打开内存分配采取不同的策略：小于 32K 的被定义为小块内存，小块内存按大小被 分为 8Bytes，16Bytes，。。。，236Bytes 进行分级。不是某个级别整数倍的大小都会被 分配向上取整。如 13Bytes 的会按 16Bytes 分配，分配时，首先在本线程相应大小级 别的空闲链表里面找，如果找到的话可以避免加锁操作（本线程的 cache 只有本线 程自己使用）。如果找不到的话，则尝试从中心内存区的相应级别的空闲链表里搬一 些对象到本线程的链表。如果中心内存区相应链表也为空的话，则向中心页分配器 请求内存页面，然后分割成该级别的对象存储。大块内存处理方式：按页分配，每 页大小是 4K，然后内存按 1 页，2 页，……，255 页的大小分类，相同大小的内存块 也用链表连接。 </p>
<h4 id="c_1">各种 C 内存管理程序实现的对比</h4>
<table>
<thead>
<tr>
<th>策略</th>
<th>分配速度</th>
<th>回收速度</th>
<th>局部缓存</th>
<th>易用性</th>
<th>通用性</th>
<th>SMP 线程友好度</th>
</tr>
</thead>
<tbody>
<tr>
<td>GNUMalloc</td>
<td>中</td>
<td>快</td>
<td>中</td>
<td>容易</td>
<td>高</td>
<td>中</td>
</tr>
<tr>
<td>Hoard</td>
<td>中</td>
<td>中</td>
<td>中</td>
<td>容易</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>TCMalloc</td>
<td>快</td>
<td>快</td>
<td>中</td>
<td>容易</td>
<td>高</td>
<td>高</td>
</tr>
</tbody>
</table>
<p>从上表可以看出，TCMalloc 的优势还是比较大的，TCMalloc 的优势体现在：</p>
<ul>
<li>
<p>分配内存页的时候，直接跟 OS 打交道，而常用的内存池一般是基于别的内存管理器 上分配，如果完全一样的内存管理策略，明显 TCMalloc 在性能及内存利用率上要省 掉第三方内存管理的开销。之所以会出现这种情况，是因为大部分写内存池的 coder 都不太了解 OS </p>
</li>
<li>
<p>大部分的内存池只负责分配，不管回收。当然了，没有回收策略，也有别的方法解 决问题。比如线程之间协调资源，模索模块一般是一写多读，也就是只有一个线程 申请、释放内存，就不存在线程之间协调资源；为了避免某些块大量空闲，常用的 做法是减少内存块的种类，提高复用率，这可能会造成内部碎片比较多，如果空闲 的内存实在太多了，还可以直接重启。   </p>
</li>
</ul>
<p>作为一个通用的内存管理库，TCMalloc 也未必能超过专用的比较粗糙的内存池。比如应用中主要用到 7 种长度的块，专用的内存池，可以只分配这 7 种长度，使得没有内部碎片。 或者利用统计信息设置内存池的长度，也可以使得内部碎片比较少。 </p>
<p>所以 TCMalloc 的意义在于，不需要增加任何开发代价，就能使得内存的开销比较少， 而且可以从理论上证明，最优的分配不会比 TCMalloc 的分配好很多。 </p>
<p>对比 Glibc 可以发现，两者的思想其实是差不多的，差别只是在细节上，细节上的差别， 对工程项目来说也是很重要的，至少在性能与内存使用率上 TCMalloc 是领先很多的。Glibc 在内存回收方面做得不太好，常见的一个问题，申请很多内存，然后又释放，只是有一小块 没释放，这时候 Glibc 就必须要等待这一小块也释放了，也把整个大块释放，极端情况下， 可能会造成几个 G 的浪费</p>
<h2 id="ptmalloc">Ptmalloc 内存管理概述</h2>
<h3 id="index_1">Index</h3>
<p>Linux 中 malloc 的早期版本是用Doug Lea 实现的, 它又一个重要的问题就是在并行处理时多个线程共享进程的内存空间，
各线程共享进程的内存空间， 各线程可能并发请求内存。</p>
<p>Wolfram Gloger 在 Doug Lea 的基础上改进使得 Glibc 的 malloc 可以支 持多线程————ptmalloc，在 glibc-2.3.x.中已经集成了ptmalloc2，这就是我们平时使用的malloc， 
目前 ptmalloc 的最新版本是ptmalloc3。ptmalloc2 的性能略微比 ptmalloc3 要高一点点。</p>
<p>ptmalloc() 实现了 malloc(), free() 以及一组其他的函数， 以提供动态内存管理的支持。 分配器处在用户程序和内核之间， 它响应用户的分配请求， 向操作系统申请内存， 然后将其返回给用户程序， 为了保持高效的分配， 
， <strong>分配器一般都会预先分配一块大于用户请求的内存</strong> ， 并通过某种算法管理这块内存， 来满足用户的内存分配要求。</p>
<p>用户释放掉的内存也并不是立即就返回给操作系统， 相反， 分配器会管理这些被释放掉的空闲空间， 以应对用户以后的内存分配要求。也就是说，分配器不但要管理已分配的内存块， 还需要管理空闲的内存块， 当响应用户分配要求时, 分配器会
先在空闲空间中寻找一块合适的内存给用户， 在空闲空间中找不到的情况下才分配一块新的内存。</p>
<p>为实现一个高效的分配器， 需要考虑很多的因素，比如：</p>
<ul>
<li>
<p>分配器本身管理内存块所占用的内存空间必须很小</p>
</li>
<li>
<p>分配算法必须足够的快</p>
</li>
</ul>
<h3 id="_7">内存管理的设计假设</h3>
<p>Ptmalloc 在设计时折种了高效率， 高空间利用率， 高可用性等设计目标。 在其实现代码中， 隐藏着内存管理中的一些设计假设。</p>
<p>由于某些设计假设， 导致了在某些情况下 ptmalloc的行为很诡异。包括：</p>
<ul>
<li>
<p>具有长生命周期的大内存分配使用mmap</p>
</li>
<li>
<p>特别大的内存分配总是使用mmap</p>
</li>
<li>
<p>具有短生命周期的内存分配使用brk。 因为使用mmap映射匿名页， 当发生缺页异常时， linux 内核为缺页分配一个新的物理页， 并将该物理页清0， 一个mmap的内存块需要映射多个物理页， 导致多次清0操作， 很浪费系统资源， 所以引入了mmap分配阈值
动态调整机制， 保证在必要的情况下才使用mmap分配内存。</p>
</li>
<li>
<p>尽量只缓存临时使用的空闲小内存块， 堆大内存块或者是长生命周期的大内存块在释放时都直接归还给操作系统</p>
</li>
<li>
<p>对空闲的小内存块只会在 malloc 和 free 的时候进行合并， free是空闲内存块可能放入 pool ， 不一定归还给操作系统</p>
</li>
<li>
<p>收缩堆的条件是当前free的块大小加上前后能合并chunk的大小大于64KB， 并且堆顶的大小达到阈值， 才有可能收缩堆， 吧堆最顶端的空闲内存
返回给操作系统</p>
</li>
<li>
<p>需要保持长期存储的程序不适合用ptmalloc来管理内存</p>
</li>
<li>
<p>为了支持多线程， 多个线程可以从同一个分配区（arena） 中分配内存， ptmalloc假设线程A 释放掉一块内存后， 线程B会申请类似大小的内存
， 但是A释放的内存跟B需要的内存不一定完全相等， 可能有一个小的误差就需要不停地对内存块进行切割和合并， 这个过程中可能产生内存碎片</p>
</li>
</ul>
<h3 id="_8">内存管理数据结构概述</h3>
<h4 id="mainarena-nonmain_arena">Main<em>arena 与 non</em>main_arena</h4>
<p>在 Doug Lea 实现的内存分配器中只有一个主分配区(main arena)，每次分配都必须对主分配区加锁， 分配完成后释放锁， 在SMP多线程环境下，对主分配区的锁
的争用很激烈，严重影响了 malloc 的分配效率。于是 Wolfram Gloger 在 Doug Lea 的基础上改进使得 Glibc 的 malloc 可以支持多线程，增加了非主分配区
（non main arena）支持，主分配区与非 主分配区用环形链表进行管理。每一个分配区利用互斥锁（mutex）使线程对于该分配区的 访问互斥。</p>
<p>每个进程只有一个主分配区，但可能存在多个非主分配区，ptmalloc 根据系统对分配区 的争用情况动态增加非主分配区的数量，分配区的数量一旦增加，就不会再减少
了。主分配区可以访问进程的 heap 区域和 mmap 映射区域，也就是说主分配区可以使用 sbrk 和 mmap 向操作系统申请虚拟内存。而非主分配区只能访问进程的 mmap
 映射区域，非主分配区每 次使用 mmap()向操作系统“批发”HEAP<em>MAX</em>SIZE（32 位系统上默认为 1MB，64 位系统默 认为 64MB）大小的虚拟内存，当用户向非主分配
 区请求分配内存时再切割成小块“零售” 出去，毕竟系统调用是相对低效的，直接从用户空间分配内存快多了。所以 ptmalloc 在必要的情况下才会调用 mmap()函数向操作
 系统申请虚拟内存。 主分配区可以访问 heap 区域，如果用户不调用 brk()或是 sbrk()函数，分配程序就可以 保证分配到连续的虚拟地址空间，因为每个进程只有一个主
 分配区使用 sbrk()分配 heap 区 域的虚拟内存。内核对 brk 的实现可以看着是 mmap 的一个精简版，相对高效一些。如果主 分配区的内存是通过mmap()向系统分配的，
 当free该内存时，主分配区会直接调用munmap() 将该内存归还给系统。 当某一线程需要调用 malloc()分配内存空间时，该线程先查看线程私有变量中是否已经 存在一个分配区，
 如果存在，尝试对该分配区加锁，如果加锁成功，使用该分配区分配内存， 如果失败，该线程搜索循环链表试图获得一个没有加锁的分配区。如果所有的分配区都已经 加锁，
 那么 malloc()会开辟一个新的分配区，把该分配区加入到全局分配区循环链表并加锁， 然后使用该分配区进行分配内存操作。在释放操作中，线程同样试图获得待释放内存块所在 
 分配区的锁，如果该分配区正在被别的线程使用，则需要等待直到其他线程释放该分配区的 互斥锁之后才可以进行释放操作。 申请小块内存时会产生很多内存碎片，ptmalloc 
 在整理时也需要对分配区做加锁操作。 每个加锁操作大概需要 5～10 个 cpu 指令，而且程序线程很多的情况下，锁等待的时间就会 延长，导致malloc性能下降。
 一次加锁操作需要消耗100ns左右，正是锁的缘故，导致ptmalloc 在多线程竞争情况下性能远远落后于 tcmalloc。最新版的 ptmalloc 对锁进行了优化，加入了 PER<em>THREAD 和 
 ATOMIC</em>FASTBINS 优化，但默认编译不会启用该优化，这两个对锁的优化应 该能够提升多线程内存的分配的效率。 </p>
<p>#### chunk 的组织</p>
<p>不管内存是在哪里被分配的，用什么方法分配，用户请求分配的空间在 ptmalloc 中都使 用一个 chunk 来表示。
用户调用 free()函数释放掉的内存也并不是立即就归还给操作系统， 相反，它们也会被表示为一个 chunk，ptmalloc 使用特定的数据结构来管理这些空闲的 chunk。</p>
<h5 id="chunk">chunk的格式</h5>
<p>ptmalloc 在给用户分配的空间的前后加上了一些控制信息，用这样的方法来记录分配的 信息，以便完成分配和释放工作。一个使用中的 chunk（使用中，就是指还没有被 free 掉） 在内存中的样子如图所示： </p>
<p><img alt="" src="https://raw.githubusercontent.com/Alikas0/files/master/img/20191120210148.png" /></p>
<p>图中chunk指针指向一个chunk的开始， 一个chunk中包含了用户请求的内存区域和相关的控制信息。 </p>
<ul>
<li>
<p>mem指针才是真正返回给用户的内存指针</p>
</li>
<li>
<p>P 表示前一个块是否在使用中</p>
<ul>
<li>值0表示前一个chunk为空闲， 这时prev_size才有效</li>
<li>值1表示前一个chunk正在使用， prev_size 无效， 程序也就不可以得到前一个chunk的大小，不能对前一个chunk进行任何操作</li>
<li>ptmalloc分配的第一个块总是将P设为1， 以防止程序引用到不存在的区域</li>
</ul>
</li>
<li>
<p>prev_size 表示前一个chunk的size， 程序可以使用这个值来找到前一个chunk的开始地址</p>
</li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../function/" title="函数" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                函数
              </span>
            </div>
          </a>
        
        
          <a href="../../big_little_ending/" title="大端序和小端序" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                大端序和小端序
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Alikas0" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://t.me/Alikas0" target="_blank" rel="noopener" title="telegram" class="md-footer-social__link fa fa-telegram"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.1",url:{base:"../../.."}})</script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/gitalk.min.js"></script>
      
        <script src="../../../js/md5.min.js"></script>
      
    
  </body>
</html>